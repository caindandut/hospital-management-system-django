{% extends "adminpanel/base_admin.html" %}
{% block title %}Bệnh nhân · Admin{% endblock %}

{% block content %}
<div class="container">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h5 class="mb-0">Quản lý bệnh nhân</h5>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#patientModal" onclick="openCreate()"><i class="bi bi-plus-lg me-1"></i>Thêm</button>
  </div>

  <form class="row g-2 mb-3">
    <div class="col-md-6">
      <input class="form-control" name="q" value="{{ q }}" placeholder="Tìm theo họ tên, email, SĐT hoặc CCCD">
    </div>
    <div class="col-md-2">
      <button class="btn btn-outline-secondary w-100">Tìm</button>
    </div>
  </form>

  <div class="card">
    <div class="table-responsive">
      <table class="table align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>STT</th>
            <th>Họ tên</th>
            <th>Email</th>
            <th>CCCD</th>
            <th>SĐT</th>
            <th>Ngày sinh</th>
            <th>Giới tính</th>
            <th>Trạng thái</th>
            <th class="text-end">Thao tác</th>
          </tr>
        </thead>
        <tbody>
          {% for p in patients %}
          <tr>
            <td>{{ forloop.counter0|add:page_obj.start_index }}</td>
            <td>{{ p.user.full_name }}</td>
            <td>{{ p.user.email }}</td>
            <td>{{ p.cccd }}</td>
            <td>{{ p.user.phone|default:'-' }}</td>
            <td>{% if p.date_of_birth %}{{ p.date_of_birth|date:'d/m/Y' }}{% else %}-{% endif %}</td>
            <td>
              {% if p.gender == 'MALE' %}Nam{% elif p.gender == 'FEMALE' %}Nữ{% else %}-{% endif %}
            </td>
            <td>{% if p.user.is_active %}<span class="badge bg-success-subtle text-success">Hoạt động</span>{% else %}<span class="badge bg-secondary-subtle text-secondary">Khóa</span>{% endif %}</td>
            <td class="text-end">
              <div class="btn-group">
                <button type="button" class="btn btn-sm btn-outline-secondary btn-view-patient" data-user-id="{{ p.user_id }}">Chi tiết</button>
                <button type="button" class="btn btn-sm btn-outline-primary btn-edit-patient" 
                        data-patient-id="{{ p.id }}"
                        data-fullname="{{ p.user.full_name }}"
                        data-email="{{ p.user.email }}"
                        data-cccd="{{ p.cccd|default:'' }}"
                        data-phone="{{ p.user.phone|default:'' }}"
                        data-dob="{% if p.date_of_birth %}{{ p.date_of_birth|date:'Y-m-d' }}{% endif %}"
                        data-gender="{{ p.gender|default:'' }}"
                        data-address="{{ p.address|default:'' }}"
                        data-active="{{ p.user.is_active|yesno:'true,false' }}">Sửa</button>
                <form method="post" action="{% url 'adminpanel:admin_patient_delete' p.id %}" class="d-inline">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-sm btn-outline-danger">Xóa</button>
                </form>
              </div>
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="9" class="text-center text-muted py-4">Chưa có bệnh nhân</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Modal Create -->
  <div class="modal fade" id="patientModal" tabindex="-1" aria-hidden="true"
       data-open-create="{% if open_create_modal %}1{% else %}0{% endif %}"
       data-open-edit="{% if open_edit_modal %}1{% else %}0{% endif %}">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <form id="patientForm" novalidate>
          {% csrf_token %}
          <div class="modal-header">
            <h5 class="modal-title" id="patientModalTitle">Thêm bệnh nhân</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Họ tên</label>
                <input name="full_name" class="form-control" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Email</label>
                <input name="email" type="email" class="form-control" required>
              </div>
              <div class="col-md-6" id="passwordGroup">
                <label class="form-label">Mật khẩu</label>
                <input name="password" type="password" class="form-control" placeholder="Để trống nếu không đổi">
              </div>
              <div class="col-md-6">
                <label class="form-label">CCCD</label>
                <input name="cccd" class="form-control" required>
              </div>
              <div class="col-md-4">
                <label class="form-label">SĐT</label>
                <input name="phone" class="form-control">
              </div>
              <div class="col-md-4">
                <label class="form-label">Ngày sinh</label>
                <input name="date_of_birth" type="date" class="form-control">
              </div>
              <div class="col-md-4">
                <label class="form-label">Giới tính</label>
                <select name="gender" class="form-select">
                  <option value="">--</option>
                  <option value="MALE">Nam</option>
                  <option value="FEMALE">Nữ</option>
                </select>
              </div>
              <div class="col-12">
                <label class="form-label">Địa chỉ</label>
                <input name="address" class="form-control">
              </div>
              <div class="col-12">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="is_active" id="ckActivePatient" checked>
                  <label class="form-check-label" for="ckActivePatient">Kích hoạt</label>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            <button class="btn btn-primary" type="submit">Lưu</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
  // Django URLs - defined here to avoid linter errors
  const URLS = {
    patientsList: '{% url "adminpanel:admin_patients_list" %}',
    patientUpdate: '{% url "adminpanel:admin_patient_update" 0 %}'
  };
  </script>
  
  <script>
  let currentPatientId = null;
  let modal = null;
  
  function openCreate() {
    currentPatientId = null;
    document.getElementById('patientModalTitle').textContent = 'Thêm bệnh nhân';
    document.getElementById('passwordGroup').style.display = '';
    document.getElementById('patientForm').reset();
    if (!modal) {
      modal = new bootstrap.Modal(document.getElementById('patientModal'));
    }
    modal.show();
  }
  
  document.addEventListener('DOMContentLoaded', function(){
    // View detail buttons
    document.querySelectorAll('.btn-view-patient').forEach(btn => {
      btn.addEventListener('click', function() {
        const userId = this.dataset.userId;
        window.location.href = URLS.patientsList + '?detail=' + userId;
      });
    });
    
    // Edit buttons
    document.querySelectorAll('.btn-edit-patient').forEach(btn => {
      btn.addEventListener('click', function() {
        currentPatientId = this.dataset.patientId;
        document.getElementById('patientModalTitle').textContent = 'Sửa bệnh nhân';
        document.getElementById('passwordGroup').style.display = '';
        
        document.querySelector('[name="full_name"]').value = this.dataset.fullname || '';
        document.querySelector('[name="email"]').value = this.dataset.email || '';
        document.querySelector('[name="cccd"]').value = this.dataset.cccd || '';
        document.querySelector('[name="phone"]').value = this.dataset.phone || '';
        document.querySelector('[name="date_of_birth"]').value = this.dataset.dob || '';
        document.querySelector('[name="gender"]').value = this.dataset.gender || '';
        document.querySelector('[name="address"]').value = this.dataset.address || '';
        document.querySelector('[name="is_active"]').checked = this.dataset.active === 'true';
        
        if (!modal) {
          modal = new bootstrap.Modal(document.getElementById('patientModal'));
        }
        modal.show();
      });
    });
    
    // Continue with existing code
    const modalEl = document.getElementById('patientModal');
    const titleEl = document.getElementById('patientModalTitle');
    const pwdGroup = document.getElementById('passwordGroup');
    const formEl = document.getElementById('patientForm');
    const shouldCreate = modalEl.getAttribute('data-open-create') === '1';
    const shouldEdit = modalEl.getAttribute('data-open-edit') === '1';
    
    // Handle form submit
    formEl.addEventListener('submit', async function(e) {
      e.preventDefault();
      const fd = new FormData(formEl);
      
      let url, method;
      if (currentPatientId) {
        // Update
        url = URLS.patientUpdate.replace('/0/', '/' + currentPatientId + '/');
        method = 'POST';
      } else {
        // Create - need to implement this endpoint
        if (window.showMessage) {
          window.showMessage('warning', 'Chức năng thêm bệnh nhân mới chưa được implement.');
        } else {
          alert('Chức năng thêm bệnh nhân mới chưa được implement trong view.');
        }
        return;
      }
      
      try {
        const res = await fetch(url, {
          method: method,
          headers: {'X-CSRFToken': '{{ csrf_token }}'},
          body: fd
        });
        const data = await res.json();
        if (data.ok) {
          if (window.showMessage) {
            window.showMessage('success', data.message || 'Đã lưu thay đổi');
            if (modal) modal.hide();
            setTimeout(() => location.reload(), 1500);
          } else {
            location.reload();
          }
        } else {
          if (window.showMessage) {
            window.showMessage('error', data.message || 'Có lỗi xảy ra');
          } else {
            alert(data.message || 'Có lỗi xảy ra');
          }
        }
      } catch (error) {
        console.error(error);
        if (window.showMessage) {
          window.showMessage('error', 'Có lỗi xảy ra khi lưu dữ liệu');
        } else {
          alert('Có lỗi xảy ra khi lưu dữ liệu');
        }
      }
    });
    
    if (shouldCreate) {
      currentPatientId = null;
      titleEl.textContent = 'Thêm bệnh nhân';
      pwdGroup.style.display = '';
      if (!modal) {
        modal = new bootstrap.Modal(modalEl);
      }
      modal.show();
    } else if (shouldEdit) {
      // This block is for URL-based edit (legacy support)
      titleEl.textContent = 'Sửa bệnh nhân';
      pwdGroup.style.display = '';
      if (!modal) {
        modal = new bootstrap.Modal(modalEl);
      }
      modal.show();
      
      // Remove query param from URL
      if (window.history && window.history.replaceState) {
        window.history.replaceState(null, '', URLS.patientsList);
      }
    }
  });
  </script>

  <!-- Modal Detail (read-only) -->
  {% if detail_user %}
  <div class="modal fade" id="modalDetail" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Chi tiết bệnh nhân</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6"><label class="form-label">Họ tên</label><input class="form-control" value="{{ detail_user.full_name }}" disabled></div>
            <div class="col-md-6"><label class="form-label">Email</label><input class="form-control" value="{{ detail_user.email }}" disabled></div>
            <div class="col-md-6"><label class="form-label">SĐT</label><input class="form-control" value="{{ detail_user.phone|default:'' }}" disabled></div>
            <div class="col-md-6"><label class="form-label">CCCD</label><input class="form-control" value="{{ detail_profile.cccd }}" disabled></div>
            <div class="col-md-6"><label class="form-label">Ngày sinh</label><input class="form-control" value="{% if detail_profile.date_of_birth %}{{ detail_profile.date_of_birth|date:'d/m/Y' }}{% endif %}" disabled></div>
            <div class="col-md-6"><label class="form-label">Giới tính</label><input class="form-control" value="{% if detail_profile.gender == 'MALE' %}Nam{% elif detail_profile.gender == 'FEMALE' %}Nữ{% else %}-{% endif %}" disabled></div>
            <div class="col-12"><label class="form-label">Địa chỉ</label><input class="form-control" value="{{ detail_profile.address|default:'' }}" disabled></div>
          </div>
        </div>
        <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button></div>
      </div>
    </div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', function(){
      const el = document.getElementById('modalDetail');
      const m = new bootstrap.Modal(el);
      m.show();
      // Xóa query ?detail= khỏi URL để F5 không tự bật lại modal
      if (window.history && window.history.replaceState) {
        window.history.replaceState(null, '', URLS.patientsList);
      }
    });
  </script>
  {% endif %}

</div>
{% endblock %}


