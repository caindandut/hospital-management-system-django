{% load vi_format %}
{% load vi_labels %}
{% load static %}
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Hóa đơn chờ thanh toán</title>
  <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
  <link href="{% static 'css/bootstrap-icons.css' %}" rel="stylesheet">
  <style>
    /* Navbar styling */
    .navbar-staff { background: #ffffff; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    .navbar-staff .navbar-brand { color: #2563eb; font-weight: 600; }
    .navbar-staff .nav-link { color: #475569; padding: 0.5rem 1rem; border-radius: 8px; }
    .navbar-staff .nav-link:hover { background: #f1f5f9; color: #2563eb; }
    .navbar-staff .nav-link.active { background: #eef5ff; color: #2563eb; }
    .navbar-staff .dropdown-menu { border: 0; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-radius: 10px; }
    .navbar-staff .dropdown-item { padding: 0.6rem 1.2rem; }
    .navbar-staff .dropdown-item:hover { background: #f3f6fb; color: #2563eb; }
    .navbar-staff .dropdown-divider { margin: 0.3rem 0; }
    .user-avatar { width: 32px; height: 32px; border-radius: 50%; background: #eef5ff; color: #2563eb; display: inline-flex; align-items: center; justify-content: center; font-weight: 600; }
    
    /* Alert styling */
    .alert { 
      max-width: 420px !important; 
      margin: 10px auto !important; 
      border-radius: 8px !important;
      padding: 10px 15px !important;
      font-size: 14px !important;
    }
    .alert .btn-close { filter: invert(1); }
    
    /* Override message container for tighter display */
    #message-container .message {
      max-width: 420px !important;
      font-size: 13px !important;
    }
    #message-container .message-text {
      max-width: 300px !important;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    /* Card styling */
    .card-soft { border: 0; box-shadow: 0 2px 12px rgba(0,0,0,0.06); border-radius: 12px; }
    
    /* Table styling */
    .table thead th { 
      position: sticky; 
      top: 0; 
      z-index: 1; 
      background: #ffffff; 
      color: #111827; 
      border-bottom: 2px solid #e5e7eb;
      font-weight: 600;
    }
    .table tbody tr:nth-child(even) { background: #fbfdff; }
    .table-hover tbody tr:hover { background: #f3f6fb; }
    .table td, .table th { vertical-align: middle; }
    
    /* Badge styling */
    .badge { font-weight: 600; border-radius: 999px; padding: 0.4rem 0.7rem; }
    .badge-warning { background-color: #fef3c7; color: #92400e; }
    .badge-success { background-color: #d1fae5; color: #065f46; }
    .badge-danger { background-color: #fee2e2; color: #991b1b; }
    
    /* Button styling */
    .btn-view { 
      background: #eef5ff; 
      color: #1d4ed8; 
      border: 1px solid #bfdbfe; 
      border-radius: 8px;
      padding: 0.4rem 0.8rem;
      font-weight: 500;
      transition: all 0.2s;
    }
    .btn-view:hover { 
      background: #dbeafe; 
      color: #1e40af; 
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(59, 130, 246, 0.15);
    }
  </style>
</head>
<body style="background-color: #f6f8fb;">
  <!-- Navigation Bar -->
  <nav class="navbar navbar-expand-lg navbar-staff sticky-top">
    <div class="container-fluid px-4">
      <a class="navbar-brand" href="{% url 'staff:staff_cashier' %}">
        <i class="bi bi-hospital me-2"></i>DUT Hospital
      </a>
      
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item">
            <a class="nav-link active" href="{% url 'staff:staff_cashier' %}">
              <i class="bi bi-receipt me-1"></i>Hóa đơn chờ thanh toán
            </a>
          </li>
        </ul>
        
        <ul class="navbar-nav">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
              <span class="user-avatar me-2">
                <i class="bi bi-person-fill"></i>
              </span>
              <span>{{ request.user.get_full_name|default:request.user.username }}</span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end">
              <li>
                <a class="dropdown-item" href="{% url 'theme:profile' %}">
                  <i class="bi bi-person-circle me-2"></i>Thông tin cá nhân
                </a>
              </li>
              <li>
                <a class="dropdown-item" href="{% url 'theme:change_password' %}">
                  <i class="bi bi-key me-2"></i>Đổi mật khẩu
                </a>
              </li>
              <li><hr class="dropdown-divider"></li>
              <li>
                <a class="dropdown-item text-danger" href="{% url 'theme:logout' %}">
                  <i class="bi bi-box-arrow-right me-2"></i>Đăng xuất
                </a>
              </li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container py-4">
    <!-- Header -->
    <div class="mb-4">
      <h3 class="text-primary mb-1">Hóa đơn chờ thanh toán</h3>
      <p class="text-muted mb-0">Quản lý và xử lý thanh toán hóa đơn</p>
    </div>
    
    <!-- Message container will be created by JavaScript -->
    <div id="message-container"></div>
    
    <!-- Django Messages -->
    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {% endfor %}
    {% endif %}
    <!-- Invoices Table -->
    <div class="card card-soft">
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th style="width: 8%;">#</th>
                <th style="width: 22%;">Bệnh nhân</th>
                <th style="width: 20%;">Bác sĩ</th>
                <th style="width: 18%;">Ngày khám</th>
                <th style="width: 15%;">Số tiền</th>
                <th style="width: 12%;">Trạng thái</th>
                <th style="width: 5%;"></th>
              </tr>
            </thead>
            <tbody>
            {% for inv in invoices %}
              <tr>
                <td class="fw-bold text-primary">#{{ inv.id }}</td>
                <td>
                  <div class="fw-semibold">{{ inv.appointment.patient.user.full_name }}</div>
                  <small class="text-muted">{{ inv.appointment.patient.user.phone|default:"-" }}</small>
                </td>
                <td>
                  <div>{{ inv.appointment.doctor.user.full_name }}</div>
                  <small class="text-muted">{{ inv.appointment.doctor.specialty.name|default:"-" }}</small>
                </td>
                <td>
                  <div>{{ inv.appointment.appointment_at|date:"d/m/Y" }}</div>
                  <small class="text-muted">{{ inv.appointment.appointment_at|date:"H:i" }}</small>
                </td>
                <td class="fw-bold text-success">{{ inv.amount_due|vnd }}</td>
                <td>
                  {% if inv.status == 'UNPAID' %}
                    <span class="badge badge-warning">
                      <i class="bi bi-clock me-1"></i>Chờ thanh toán
                    </span>
                  {% elif inv.status == 'PAID' %}
                    <span class="badge badge-success">
                      <i class="bi bi-check-circle me-1"></i>Đã thanh toán
                    </span>
                  {% else %}
                    <span class="badge badge-danger">{{ inv.status|invoice_vi }}</span>
                  {% endif %}
                </td>
                <td class="text-end">
                  <a class="btn btn-sm btn-view" href="{% url 'staff:staff_invoice_detail' inv.id %}">
                    <i class="bi bi-eye me-1"></i>Xem
                  </a>
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="7" class="text-center py-5">
                  <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
                  <p class="text-muted mt-2 mb-0">Không có hóa đơn chờ thanh toán</p>
                </td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
  <script>
    // Remove duplicate alerts before message-system.js processes them
    document.addEventListener('DOMContentLoaded', function() {
        const alerts = Array.from(document.querySelectorAll('.alert'));
        const seen = new Set();
        alerts.forEach(a => {
            const txt = a.textContent.replace(/×/g, '').trim();
            if (seen.has(txt)) {
                a.remove();
            } else {
                seen.add(txt);
            }
        });
    });
  </script>
  <script src="{% static 'js/message-system.js' %}"></script>
</body>
</html>
